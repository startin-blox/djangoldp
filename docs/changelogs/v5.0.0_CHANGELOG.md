# Version Changelog: v5.0.0

**Work branch**: `update/improve-ldp-compliance`
**Base**: `master`
**Date**: 2025

This document describes all changes introduced in this version, focusing on improved W3C LDP compliance, Django 5 upgrade, and architectural improvements.

---

## Summary of Changes

This version introduces significant improvements to DjangoLDP:

1. **Django 5 LTS Upgrade** - Major framework upgrade
2. **Turtle (TTL) Serialization** - Full RDF Turtle parser and renderer
3. **ETag & Conditional Requests** - RFC 7232 compliance
4. **Link Headers & Pagination** - W3C LDP Paging support
5. **CORS Improvements** - Exposed headers for LDP clients
6. **Prefer Headers** - RFC 7240 support
7. **OPTIONS Method** - Full implementation
8. **File Architecture** - Serializers, renderers, parsers reorganized

---

## 1. Django 5 LTS Upgrade

**Commit**: `c268199 major: upgrading to django5 LTS and better files architecture`

### Changes
- Upgraded from Django 4.2 to Django 5.2 LTS
- Updated all dependencies for Django 5 compatibility
- Fixed deprecated API calls

### Migration Notes
- Applications using DjangoLDP need to ensure Django 5 compatibility
- Check Django 5 release notes for any breaking changes in your code

---

## 2. Turtle (TTL) Serialization

**Commits**:
- `a007a71 feature: adding turtle parser and renderer`
- `72b401f update: split renderer and parsers into their own files`
- `03fbf71 fix: turtle serialisation of complete resources`

### New Features

#### TurtleRenderer
Located in `djangoldp/renderers.py`

- Full RDF Turtle serialization support
- Content negotiation via `Accept: text/turtle`
- 3-strategy fallback system for robust serialization:
  1. JSON-LD expansion with context resolution
  2. Direct parsing without expansion
  3. Custom recursive converter for nested resources

#### TurtleParser
Located in `djangoldp/parsers.py`

- Parse incoming Turtle data
- Content-Type: `text/turtle`
- Automatic conversion to JSON-LD for internal processing

### Usage

**Request Turtle format:**
```bash
curl -H "Accept: text/turtle" http://localhost:8000/users/
```

**Response:**
```turtle
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix hd: <http://happy-dev.fr/owl/#> .

<http://localhost:8000/users/> a ldp:BasicContainer ;
    ldp:contains <http://localhost:8000/users/1/>,
                 <http://localhost:8000/users/2/> .

<http://localhost:8000/users/1/> a hd:user ;
    hd:username "alice" ;
    hd:email "alice@example.com" .
```

**POST with Turtle:**
```bash
curl -X POST \
  -H "Content-Type: text/turtle" \
  -d '@prefix hd: <http://happy-dev.fr/owl/#> .
      <> a hd:user ;
         hd:username "newuser" ;
         hd:email "new@example.com" .' \
  http://localhost:8000/users/
```

### Documentation
- See `docs/TURTLE_LIMITATIONS.md` for detailed explanation of Turtle vs JSON-LD differences

---

## 3. ETag & Conditional Requests

**Commits**:
- `39894f8 feature: etag support`
- `34255ce remove: brotli middleware by default to allow valid etags`

### New Features

#### ETag Generation
Located in `djangoldp/etag.py`

- Weak ETags (`W/"..."`) for all resources
- Container ETags based on contained resources
- ETags change when resources are modified

#### Conditional Request Headers

| Header | Support | Description |
|--------|---------|-------------|
| `If-Match` | ✅ | Require ETag match for updates (412 on mismatch) |
| `If-None-Match` | ✅ | Return 304 if resource unchanged (GET), 412 for PUT |
| `If-Modified-Since` | ✅ | Return 304 if not modified since timestamp |
| `Last-Modified` | ✅ | Response header with last modification time |

### Usage

**GET with caching:**
```bash
# First request - get ETag
curl -i http://localhost:8000/users/1/
# Response includes: ETag: W/"abc123"

# Subsequent request - use ETag
curl -H 'If-None-Match: W/"abc123"' http://localhost:8000/users/1/
# Returns 304 Not Modified if unchanged
```

**Conditional updates:**
```bash
# Update only if ETag matches (prevents concurrent update conflicts)
curl -X PUT \
  -H 'If-Match: W/"abc123"' \
  -H 'Content-Type: application/ld+json' \
  -d '{"username": "updated"}' \
  http://localhost:8000/users/1/
# Returns 412 Precondition Failed if ETag doesn't match
```

**Time-based caching:**
```bash
curl -H 'If-Modified-Since: Mon, 21 Oct 2025 12:00:00 GMT' \
  http://localhost:8000/users/1/
# Returns 304 if not modified since that time
```

### Model Requirements

For `If-Modified-Since` support, add timestamp fields to your models:

```python
from djangoldp.models import Model
from django.db import models

class MyModel(Model):
    name = models.CharField(max_length=255)

    # Add these for If-Modified-Since support
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

---

## 4. Link Headers & Pagination

**Commit**: `61824ce feature: adding link headers pagination support`

### New Features

#### LDP Link Headers

All responses now include proper LDP Link headers:

**Container responses:**
```
Link: <http://www.w3.org/ns/ldp#Resource>; rel="type"
Link: <http://www.w3.org/ns/ldp#RDFSource>; rel="type"
Link: <http://www.w3.org/ns/ldp#Container>; rel="type"
Link: <http://www.w3.org/ns/ldp#BasicContainer>; rel="type"
```

**Resource (detail) responses:**
```
Link: <http://www.w3.org/ns/ldp#Resource>; rel="type"
Link: <http://www.w3.org/ns/ldp#RDFSource>; rel="type"
```

#### Pagination Link Headers

When pagination is enabled, responses include RFC 8288 pagination links:

```
Link: <http://localhost:8000/users/?page=1>; rel="first"
Link: <http://localhost:8000/users/?page=5>; rel="last"
Link: <http://localhost:8000/users/?page=2>; rel="prev"
Link: <http://localhost:8000/users/?page=4>; rel="next"
```

### Configuration

```python
# settings.py
REST_FRAMEWORK = {
    'DEFAULT_PAGINATION_CLASS': 'djangoldp.pagination.LDPPagination',
    'PAGE_SIZE': 20
}
```

---

## 5. CORS Improvements

**Commit**: `fd9a6ef adding: expose_headers support`

### Exposed Headers

The following headers are now exposed for CORS clients:

```
Access-Control-Expose-Headers: Link, ETag, Last-Modified, Accept-Post, Accept-Patch, Preference-Applied, Location, User, Allow
```

This allows JavaScript clients to access:
- `Link` - Pagination and LDP type information
- `ETag` - For conditional requests
- `Last-Modified` - For time-based caching
- `Accept-Post` - Supported content types for POST
- `Accept-Patch` - Supported content types for PATCH
- `Preference-Applied` - Confirm Prefer header was honored
- `Location` - URI of newly created resources
- `Allow` - Allowed HTTP methods

---

## 6. Prefer Headers (RFC 7240)

### Supported Preferences

| Preference | Behavior |
|------------|----------|
| `return=minimal` | Returns 204 No Content after successful operation |
| `return=representation` | Returns full resource in response body (default) |

### Usage

**Minimal response (faster):**
```bash
curl -X POST \
  -H 'Prefer: return=minimal' \
  -H 'Content-Type: application/ld+json' \
  -d '{"username": "newuser"}' \
  http://localhost:8000/users/
# Returns 204 No Content with Location header
```

**Full response:**
```bash
curl -X POST \
  -H 'Prefer: return=representation' \
  -H 'Content-Type: application/ld+json' \
  -d '{"username": "newuser"}' \
  http://localhost:8000/users/
# Returns 201 Created with full resource in body
```

The `Preference-Applied` header confirms the preference was honored:
```
Preference-Applied: return=minimal
```

---

## 7. OPTIONS Method

### Implementation

Full OPTIONS method support with:
- `Allow` header showing available methods
- `Accept-Post` header for containers (JSON-LD, Turtle)
- `Accept-Patch` header for detail views
- LDP Link headers
- Empty response body

### Usage

**Container OPTIONS:**
```bash
curl -X OPTIONS http://localhost:8000/users/
```

Response headers:
```
Allow: GET, POST, HEAD, OPTIONS
Accept-Post: application/ld+json, text/turtle
Link: <http://www.w3.org/ns/ldp#BasicContainer>; rel="type"
```

**Resource OPTIONS:**
```bash
curl -X OPTIONS http://localhost:8000/users/1/
```

Response headers:
```
Allow: GET, PUT, PATCH, DELETE, HEAD, OPTIONS
Accept-Patch: application/ld+json, text/turtle
Link: <http://www.w3.org/ns/ldp#Resource>; rel="type"
```

---

## 8. File Architecture Improvements

**Commits**:
- `5e41c0a update: splitting serializers in different files`
- `72b401f update: split renderer and parsers into their own files`

### New File Structure

```
djangoldp/
├── renderers.py          # NEW: JSONLDRenderer, TurtleRenderer
├── parsers.py            # NEW: JSONLDParser, TurtleParser
├── etag.py               # NEW: ETag generation utilities
│
├── serializers/          # REFACTORED: Now a package
│   ├── __init__.py       # Re-exports all classes
│   ├── cache.py          # InMemoryCache, GLOBAL_SERIALIZER_CACHE
│   ├── fields.py         # JsonLd*Field classes
│   ├── list_serializer.py
│   ├── mixins.py         # RDFSerializerMixin, LDListMixin, etc.
│   └── model_serializer.py  # LDPSerializer (main)
│
└── serializers.py        # Backwards compatibility shim
```

### Backward Compatibility

Existing imports continue to work:

```python
# These still work (via shim)
from djangoldp.serializers import LDPSerializer

# New recommended imports
from djangoldp.serializers.model_serializer import LDPSerializer
from djangoldp.renderers import TurtleRenderer, JSONLDRenderer
from djangoldp.parsers import TurtleParser, JSONLDParser
```

---

## Commit History

From oldest to newest on this version:

```
34255ce remove: brotli middleware by default to allow valid etags
fd9a6ef adding: expose_headers support
39894f8 feature: etag support
61824ce feature: adding link headers pagination support
a007a71 feature: adding turtle parser and renderer
b57fd78 adding: missing tests run instruction
72b401f update: split renderer and parsers into their own files
0446ea8 adding: missing renderer tests
03fbf71 fix: turtle serialisation of complete resources
c952ff7 adding: proper real world test
9061050 fix: move docs into docs
99cd43b improve: test coverage of the options
5e41c0a update: splitting serializers in different files
c268199 major: upgrading to django5 LTS and better files architecture
dfaef3c fix: unit tests and a few default info
eb9e72d fix: missing method from drf
498b020 fix: unit test
8cd7ac9 fix: update ARCHITECTURE.md
7a1600e fix: double context present in some endpoints
615c879 fix: django version
```

---

## Testing

Run all tests:
```bash
source venv/bin/activate
python -m unittest djangoldp.tests.runner
```

Run specific compliance tests:
```bash
# LDP compliance
python -m unittest djangoldp.tests.test_ldp_compliance

# ETag compliance
python -m unittest djangoldp.tests.test_etag_compliance

# Pagination and CORS
python -m unittest djangoldp.tests.test_pagination_cors

# Prefer headers and OPTIONS
python -m unittest djangoldp.tests.test_prefer_options

# Renderers and parsers
python -m unittest djangoldp.tests.test_renderers_parsers
```

---

## Related Documentation

- `docs/ARCHITECTURE.md` - Overall architecture documentation
- `docs/TURTLE_LIMITATIONS.md` - Turtle serialization details
- `LDP_COMPLIANCE_STATUS.md` - W3C LDP compliance status

---

## Migration Guide

### From Previous DjangoLDP Versions

1. **Update Django to 5.2 LTS**
   ```bash
   pip install Django>=5.2,<6.0
   ```

2. **Update DjangoLDP**
   ```bash
   pip install djangoldp>=5.0.0
   ```

3. **Check Middleware**
   - BrotliMiddleware has been removed from defaults (was corrupting ETags)
   - If you need Brotli compression, configure it manually after ETag generation

4. **Optional: Add Timestamp Fields**
   - For `If-Modified-Since` support, add `updated_at` field to your models

5. **Check Import Paths**
   - Serializer imports still work but consider updating to new paths
   - Renderer/parser imports now come from dedicated modules

### Breaking Changes

- Django 5 required (minimum version)
- BrotliMiddleware no longer in default middleware
- Some internal serializer method signatures may have changed

---

## Contributors

This version was developed to improve W3C LDP specification compliance and modernize the DjangoLDP codebase for Django 5 LTS.
